# シェルのクォートとサニタイジングの違い

## 概要

GitHub Actionsのワークフローで「中間環境変数」のテクニックが推奨される理由は、シェルのクォート機能を使ってインジェクション攻撃を防ぐため。「クォート」と「サニタイジング」は似ているが異なる概念。

## クォート（Quoting）

### 定義
シェルスクリプトにおける**文法機能**で、特殊文字の解釈を制御する仕組み。

### 機能
ダブルクォート (`"..."`) で囲むと以下が抑止される：
- **トークン分割**（単語分割）：スペースで複数の引数に分かれない
- **パス名展開**（グロブ展開）：`*` や `?` が展開されない

### 例
```bash
# クォートなし - 危険
echo $ACTOR  # スペースや特殊文字で分割される

# ダブルクォートあり - 安全
echo "${ACTOR}"  # 一つの文字列として扱われる
```

## サニタイジング（Sanitizing）

### 定義
データから危険な文字を**除去・置換・エスケープ**する処理そのもの。

### 例
```javascript
// サニタイジングの例
const sanitized = input.replace(/[;&|]/g, '');
```

## 違いと関係

| 項目 | クォート | サニタイジング |
|------|---------|---------------|
| 性質 | シェルの文法機能 | データ変換処理 |
| データ | 変更しない | 変更する（除去・置換） |
| 目的 | 解釈を制御 | 危険な文字を除去 |
| 実装 | シェルの仕様 | アプリケーション側 |

**この文脈では**：クォートが「シェルインジェクション防止」という**サニタイジングに似た効果**をもたらしている。

## 具体的な攻撃例

### 危険な実装
```yaml
name: Unsafe
on: push
jobs:
  print:
    runs-on: ubuntu-latest
    steps:
      - run: echo ${{github.actor}}
```

もし `github.actor` が `user; rm -rf /` だったら：
```bash
echo user; rm -rf /  # 2つのコマンドとして実行される！
```

### 安全な実装（中間環境変数 + クォート）
```yaml
name: Safe
on: push
jobs:
  print:
    runs-on: ubuntu-latest
    env:
      ACTOR: ${{github.actor}}  # 1. コンテキストを環境変数へセット
    steps:
      - run: echo "${ACTOR}"    # 2. 環境変数をダブルクォートで参照
```

これなら：
```bash
echo "user; rm -rf /"  # 単なる文字列として出力される
```

## 推奨されるコーディングルール

1. **コンテキストはシェルコマンドへハードコードせず、環境変数を経由して渡す**
2. **環境変数はすべてダブルクォーテーションで囲む**

このルールを徹底することで、どのコンテキストに特殊文字が含まれるかを個別に把握しなくても、安全にワークフローを実装できる。

## まとめ

- **クォート**：シェルの仕組みを使った「防御的プログラミング」の手法
- **サニタイジング**：より広い概念で、データの無害化処理全般
- GitHub Actionsの文脈では、クォートが**シェルインジェクション対策としてサニタイジングに似た役割**を果たす
- 厳密には「シェルの特殊文字解釈を抑制する文法機能」だが、実用上は「サニタイジングの一種」と理解しても問題ない

## 参考
- GitHub Actions公式ドキュメント：セキュリティ強化のためのスクリプト
- シェルスクリプトのクォートルール（Bash仕様）
